# 完成项目的基本配置

将`application.properties`重命名为`application.yml`，并另外创建`application-dev.yml`。

在`application.yml`中添加配置：

```yaml
# 激活Profile配置

# 指定Mybatis的XML文件的位置

# 响应JSON时不包含为null的属性

# 开启Knife4j的增强模式
```

在`application-dev.yml`中添加配置：

```yaml
# 指定服务端口

# 配置连接数据库的参数

# 日志显示级别
```

在根包下创建`config.MybatisConfiguration`配置类，在此配置类上添加`@MapperScan`以配置接口所在的包（此包尚且不存在，可以此时就把包也创建出来）。

在根包下创建`config.Knife4jConfiguration`配置类，注意，此类中需要调整控制器类所在的包（此包尚且不存在，可以此时就把包也创建出来）。

在根包下创建`config.WebMvcConfiguration`配置类，实现`WebMvcConfigurer`接口，重写`addCorsMappings()`方法，以解决跨域访问的问题（此问题尚未出现，但可提前完成此项配置）。

完成以上配置后，应该在`src/test/java`下找到默认的配置类，执行其中的`contextLoads()`方法，此方法的方法体是空的，理应通过测试！

继续在测试类中添加方法，尝试连接数据库，以检查以上配置的“连接数据库的参数”是否正确：

```java
@Autowired
DataSource dataSource; // 导包时注意：此接口是javax.sql包中的

@Test
void testConnection() throws Throwable {
    dataSource.getConnection();
}
```

接下来，将此前项目中的“Mybatis拦截器（用于解决`gmt_create`、`gmt_modified`的）”复制到当前项目中，并在`MybatisConfiguration`中添加配置。

完成后，再次执行以上测试，确保新增代码后仍能够正常通过测试。

# 添加管理员

## 持久层

创建`pojo.entity.Admin`类，类的属性与`ams_admin`表保持一致。

在根包下创建`mapper.AdminMapper`接口，并在接口中添加抽象方法：

```java
int insert(Admin admin);
```

为了保证后续登录时使用的“用户名”是唯一的，在插入数据之前，还需要检查“此用户名是否已经存在”，则需要实现查询功能：

```java
int countByUsername(String username);
```

在`src/main/resources/mapper`下，通过粘贴得到`AdminMapper.xml`，在此文件中配置以上2个抽象方法映射的SQL语句：

```xml
<!-- 顶部的固定代码 -->

<mapper namespace="AdminMapper接口的全限定名">
	<insert id="insert" useGeneratedKey="true" keyProperty="id">
        插入管理员数据的SQL语句，不需要处理gmt_create和gmt_modified
    </insert>
    
    <select id="countByUsername" resultType="int">
        根据用户名统计数量的SQL语句
    </select>
</mapper>
```

在`src/test/java`下的根包下，创建`mapper.AdminMapperTests`测试类，在此类中自动装配`AdminMapper`对象，并测试以上2个方法：

```java
package cn.tedu.csmall.passport.mapper;

import cn.tedu.csmall.passport.pojo.entity.Admin;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
@Slf4j
public class AdminMapperTests {

    @Autowired
    AdminMapper mapper;

    @Test
    void testInsert() {
        Admin admin = new Admin();
        admin.setUsername("test-admin-001");
        admin.setPassword("123456");

        log.debug("插入数据之前，参数={}", admin);
        int rows = mapper.insert(admin);
        log.debug("插入数据完成，受影响的行数={}", rows);
        log.debug("插入数据之后，参数={}", admin);
    }

    @Test
    void testCountByUsername() {
        String username = "test-admin-007";
        int count = mapper.countByUsername(username);
        log.debug("根据用户名【{}】统计，数量={}", username, count);
    }

}
```

## 业务逻辑层

**关于业务接口**

在根包下创建`pojo.dto.AdminAddNewDTO`类，在此类中添加”添加管理员时需要提交的请求参数“，包括：`username`、`password`、`nickname`, `avatar`, `phone`, `email`, `description`, `enable`。

在根包下创建`service.IAdminService`接口，并在此接口中添加”添加管理员“的抽象方法：

```java
public interface IAdminService {
    void addNew(AdminAddNewDTO adminAddNewDTO);
}
```

**关于业务实现类**

在根包下创建`web.ServiceCode`接口，此接口可参考此前项目中的同名接口。

在根包下创建`ex.ServiceException`，此异常类可参考此前项目中的同名异常类。

在根包下创建`service.impl.AdminServiceImpl`类，实现以上`IAdminService`接口，添加`@Service`注解，并在类中自动装配`AdminMapper`对象。

关于重写的方法：

```java
@Override
public void addNew(AdminAddNewDTO adminAddNewDTO) {
    // 日志
    // 从参数中获取尝试添加的管理员的用户名
    // 调用adminMapper对象的countByUsername()方法进行统计
    // 判断统计结果是否大于0
    // 是：日志，抛出ServiceException
    
    // 创建新的Admin对象
    // 调用BeanUtils.copyProperties()方法将参数的属性值复制到以上Admin对象中
    // 补全Admin对象的属性值：loginCount >>> 0
    // 日志
    // 调用adminMapper对象的insert()方法插入数据，并获取返回的受影响的行数
    // 判断受影响的行数是否不等于1
    // 是：日志，抛出ServiceException
}
```

**编写并执行测试**

在`src/test/java`下的根包下，创建`service.AdminServiceTests`测试，在此类中测试以上方法：

```java

```

## 控制器层